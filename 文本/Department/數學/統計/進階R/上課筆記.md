```R
#安裝吳銘漢的套件
install.packages("gridExtra")
# 安裝書的套件
install.packages("Lahman")
vignette("vignette-intro", package = "Lahman")
install.packages("remotes")
remotes::install_github("beanumber/abdwr3edata")
install.packages("tidyverse")

install.packages(c("tidyverse","shiny","ggplot2","rvest","xml2","geomtextpath","promises"))

R.version.string


library(Lahman)
library(tidyverse)
library(remotes)
library(abdwr3edata)

# 2.4.2
spahn |> 
  slice(1:3) |> 
  select(1:10)

spahn |> 
  slice(1:10) |> 
  select(Age, W, L, ERA)

spahn |>
  summarize(
    LO = min(ERA), 
    QL = quantile(ERA, .25), 
    QU = quantile(ERA, .75),
    M = median(ERA), 
    HI = max(ERA)
  )

spahn |> 
  filter(ERA == min(ERA)) |> 
  select(Age)

#2.4.3
spahn <- spahn |> 
  mutate(FIP = (13 * HR + 3 * BB - 2 * SO) / IP)

spahn |> 
  arrange(FIP) |> 
  select(Year, Age, W, L, ERA, FIP) |>
  slice(1:6)

spahn |> 
  filter(Tm == "BSN" | Tm == "MLN") |>
  group_by(Tm) |> 
  summarize(
    mean_W.L = mean(W.L, na.rm = TRUE),
    mean_ERA = mean(ERA),
    mean_WHIP = mean(WHIP),
    mean_FIP = mean(FIP)
  )

# 2.4.4
batting <- bind_rows(NLbatting, ALbatting)

NL <- inner_join(NLbatting, NLpitching, by = "Tm")

NL_150 <- NLbatting |> 
  filter(HR > 150)

#2.5.1
W <- c(8, 21, 15, 21, 21, 22, 14)
L <- c(5, 10, 12, 14, 17, 14, 19)

win_pct <- 100 * W / (W + L)

Year <- seq(from = 1946, to = 1952)
Year

Age <- Year - 1921

plot(Age, win_pct)

#2.5.2
mean(win_pct)

100 * sum(W) / (sum(W) + sum(L))

sort(W)

cumsum(W)

summary(win_pct)

#2.5.3

W[c(1, 2, 5)]

W[1 : 4]

W[-c(1, 6)]

win_pct > 60

(W > 20) & (win_pct > 60)

win_pct == max(win_pct)

Year[win_pct == max(win_pct)]

Year[W + L > 30]

#2.6.1
Year <- 2008 : 2017
NL <- c("PHI", "PHI", "SFN", "SLN", "SFN",
        "SLN", "SFN", "NYN", "CHN", "LAN")
AL <- c("TBA", "NYA", "TEX", "TEX", "DET",
        "BOS", "KCA", "KCA", "CLE", "HOU")
Winner <- c("NL", "AL", "NL", "NL", "NL",
            "AL", "NL", "AL", "NL", "AL")
N_Games <- c(5, 6, 5, 7, 4, 7, 7, 5, 7, 7)

WS_results <- tibble(
  Year = Year, NL_Team = NL, AL_Team = AL,
  N_Games = N_Games, Winner = Winner)
WS_results

grep("NY", c(AL, NL), value = TRUE)

WS <- WS_results |> 
  group_by(Winner) |> 
  summarize(N = n())
WS

ggplot(WS, aes(x = Winner, y = N)) + 
  geom_col()

ggplot(WS_results, aes(x = Winner)) + 
  geom_bar()
#2.6.2
WS_results |> 
  group_by(NL_Team) |> 
  summarize(N = n())

WS_results <- WS_results |>
  mutate(
    NL_Team = factor(
      NL_Team, 
      levels = c("NYN", "PHI", "CHN", "SLN", "LAN", "SFN")
    )
  )

str(WS_results$NL_Team)

WS_results |> 
  group_by(NL_Team) |> 
  summarize(N = n())

#2.6.3
world_series <- list(
  Winner = Winner, 
  Number_Games = N_Games,
  Seasons = "2008 to 2017"
)

world_series$Number_Games
world_series[[2]]
pluck(world_series, "Number_Games")
world_series["Number_Games"]

WS_results$NL_Team
pull(WS_results, NL_Team)

#2.7.1
library(Lahman)
ws <- SeriesPost |>
  filter(yearID >= 1903, round == "WS", wins + losses < 8)
ggplot(ws, aes(x = wins + losses)) +
  geom_bar(fill = "#ffb3c6") +
  labs(x = "Number of games", y = "Frequency")
#2.7.2
hr_rates <- function(age, hr, ab) {
  rates <- round(100 * hr / ab, 1)
  list(x = age, y = rates)
}

HR <- c(13, 23, 21, 27, 37, 52, 34, 42, 31, 40, 54)
AB <- c(341, 549, 461, 543, 517, 533, 474, 519, 541, 527, 514)
Age <- 19 : 29
hr_rates(Age, HR, AB)

plot(hr_rates(Age, HR, AB))
#2.8.1
getwd()

mantle_hr_rates <- hr_rates(Age, HR, AB)
Mantle <- tibble(
  Age, HR, AB, Rates = mantle_hr_rates$y
)

write_csv(Mantle, here::here("data/mantle.csv"))
list.files(here::here("data"), pattern = "mantle")

#2.10
Batting_60 <- Batting |> 
  filter(yearID >= 1960, yearID <= 1969)

hr_60 <- Batting_60 |> 
  group_by(playerID) |> 
  summarize(HR = sum(HR))

hr_60 |> 
  arrange(desc(HR)) |>
  slice(1:4)

Batting |> 
  filter(yearID >= 1960, yearID <= 1969) |>
  group_by(playerID) |> 
  summarize(HR = sum(HR)) |>
  arrange(desc(HR)) |>
  slice(1:4)

#2.10.1
hr_leader <- function(data) {
  data |> 
    group_by(playerID) |> 
    summarize(HR = sum(HR)) |>
    arrange(desc(HR)) |>
    slice(1)
}

Batting_decade <- Batting |>
  mutate(decade = 10 * floor(yearID / 10)) |>
  group_by(decade)

decades <- Batting_decade |>
  group_keys() |>
  pull("decade")
decades

Batting_decade |>
  group_split() |>
  map(hr_leader) |>
  set_names(decades) |>
  bind_rows(.id = "decade")

# 2.10.1 ver.apply

Batting$decade <- 10 * floor(Batting$yearID / 10)

hr_leader_base <- function(df) {
  agg <- aggregate(HR ~ playerID, data = df, sum, na.rm = TRUE)
  agg[which.max(agg$HR), , drop = FALSE]
}

lst <- split(Batting, Batting$decade)
leaders_list <- lapply(lst, hr_leader_base)

leaders_df <- do.call(rbind, Map(function(dec, x) {
  cbind(decade = as.integer(dec), x)
}, names(leaders_list), leaders_list))

row.names(leaders_df) <- NULL
leaders_df[order(leaders_df$decade), ]


#2.10.2
long_careers <- Batting |> 
  group_by(playerID) |> 
  summarize(
    tAB = sum(AB, na.rm = TRUE),
    tHR = sum(HR, na.rm = TRUE),
    tSO = sum(SO, na.rm = TRUE)
  )

Batting_5000 <- long_careers |>
  filter(tAB >= 5000)

Batting_5000 |>
  slice(1:6)

ggplot(Batting_5000, aes(x = tHR / tAB, y = tSO / tAB)) +
  geom_point() + geom_smooth(color = "#ffb3c6")

#練習
# 第一大題
# a.

Player <- c("Rickey Henderson","Lou Brock","Ty Cobb","Tim Raines","Eddie Collins",
            "Max Carey","Joe Morgan","Ozzie Smith","Barry Bonds","Ichiro Suzuki",
            "Luis Aparicio","Paul Molitor","Roberto Alomar")

SB <- c(1406, 938, 896, 808, 741, 738, 689, 580, 514, 509, 506, 504, 474)
CS <- c( 335, 307, 178, 146, 173,  92, 162, 148, 141, 117, 136, 131, 114)
G  <- c(3081,2616,3035,2502,2826,2476,2649,2573,2986,2653,2601,2683,2379)
# b.

SB_Attempt <- SB + CS
SB_Attempt
# c.

Success_Rate <- SB / SB_Attempt
Success_Rate

# d.

SB_per_Game <- SB / G
SB_per_Game

# e.
df <- data.frame(Player, SB, CS, G, SB_Attempt, Success_Rate, SB_per_Game)

ggplot(df, aes(x = SB_per_Game, y = Success_Rate)) +
  geom_point(size = 3) +
  geom_text(aes(label = Player), vjust = -0.8) +
  labs(x = "SB per Game", y = "Success Rate")
#所以你可以看到
#Lou Brock盜壘成功率最低
#Max Carey盜壘成功率最高
#Rickey henderson盜壘次數最多

# 第二大題
# a.
outcome <- c("Single","Out","Out","Single","Out","Double","Out","Walk","Out","Single")
outcome

# b.
outcome_table <-table(outcome)
outcome_table

#c.
f.outcome <- factor(
  outcome,
  levels = c("Out","Walk","Single","Double")
)
f.outcome

















# 吳銘漢ggplot2
library(ggplot2)
ggplot(data=iris,aes(x=Sepal.Length,y=Sepal.Width,color= Species))+geom_point(size=3)
# 顏色2
bp <- ggplot(iris, aes(x = Species, y = Sepal.Length, fill = Species)) + geom_boxplot()
bp
sp <- ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +
  geom_point(size = 3)
sp
bp + scale_fill_hue(l = 50, c = 40)
sp + scale_color_hue(l = 30, c = 40)
#佈景主題

library(gridExtra)
p <- ggplot(iris, aes(x = Species, y = Sepal.Length)) + geom_boxplot()
p1 <- p + theme_gray() + labs(title = "gray")
p2 <- p + theme_bw() + labs(title = "bw")
p3 <- p + theme_linedraw() + labs(title = "linedraw")
p4 <- p + theme_light() + labs(title = "light")
p5 <- p + theme_dark() + labs(title = "dark")
p6 <- p + theme_minimal() + labs(title = "minimal")
p7 <- p + theme_classic() + labs(title = "classic")
grid.arrange(p, p1, p2, p3, p4, p5, p6, p7, nrow = 2, ncol = 4)







# 2020年立委席次分配（做了一個2020年的，因為我蠻喜歡時代力量的）
library(ggpol)
bt <- data.frame(
  parties = factor(c("民主進步黨","中國國民黨","臺灣民眾黨","時代力量","臺灣基進"),
                   levels = c("民主進步黨","中國國民黨","臺灣民眾黨","時代力量","臺灣基進")),
  seats   = c(61,38,5,3,1),
  colors  = c("green", "blue", "lightblue", "yellow", 
              "darkred"),
  stringsAsFactors = FALSE)

ggplot(bt) + 
  geom_parliament(aes(seats = seats, fill = parties), color = "black") + 
  scale_fill_manual(values = bt$colors, labels = bt$parties) +
  coord_fixed() + 
  theme_void()

# 2024年立委席次分配
bt <- data.frame(
  parties = factor(c("中國國民黨","民主進步黨","臺灣民眾黨"),
                   levels = c("中國國民黨","民主進步黨","臺灣民眾黨")),
  seats   = c(52,51,8),
  colors  = c("green", "blue", "lightblue"),
  stringsAsFactors = FALSE)

ggplot(bt) + 
  geom_parliament(aes(seats = seats, fill = parties), color = "black") + 
  scale_fill_manual(values = bt$colors, labels = bt$parties) +
  coord_fixed() + 
  theme_void()
```

# 2025.10.20
```R
#3.10 exercise 1
install.packages("here")
library(tidyverse)
library(remotes)
remotes::install_github("beanumber/abdwr3edata")
library(abdwr3edata)
library(here)

library(tidyverse)
library(abdwr3edata)

# 第一小題
hofpitching <- abdwr3edata::hof_pitching

hofpitching <- hofpitching %>%
  mutate(
    BF_group = cut(
      BF,
      breaks = c(0, 10000, 15000, 20000, 30000),
      right  = TRUE,
      labels = c("< 10,000", "(10,000, 15,000]", "(15,000, 20,000]", "(20,000,30,000]")
    )
  )

freq_tbl <- hofpitching %>%
  group_by(BF_group) %>%
  summarize(freq = n(), .groups = "drop") %>%
  arrange(BF_group)

freq_tbl
# 第二小題
ggplot(freq_tbl, aes(x = BF_group, y = freq)) +
  geom_col(width = 0.7) +
  labs(x = "Batters Faced (grouped)", y = "Number of HOF pitchers",
       title = "HOF Pitchers by Career Batters Faced") +
  theme_minimal(base_size = 13) #根據輸出我們可以知道面對20,000名投手的名人堂投手有14名

# 第三小題
ggplot(freq_tbl, aes(x = freq, y = BF_group)) +
  geom_segment(aes(x = 0, xend = freq, y = BF_group, yend = BF_group), linewidth = 0.7) +
  geom_point(size = 3) +
  labs(x = "Number of HOF pitchers", y = "Batters Faced (grouped)",
       title = "Cleveland Dot Plot: HOF Pitchers by BF Groups") +
  theme_minimal(base_size = 13)


retro_data <- baseballr::retrosheet_data(
  here::here("data_large/retrosheet"),
  c(1992, 1996, 1998, 2016)
)





install.packages("Lahman")
install.packages("ggplot2")
install.packages("broom")
install.packages("remotes")
remotes::install_github("beanumber/abdwr3edata")
install.packages("ggrepel")
install.packages("skimr")

#4.2
library(Lahman)
library(dplyr)
library(remotes)
library(ggplot2)
Teams |>
  slice_tail(n = 3)

my_teams <- Teams |>
  filter(yearID > 2000, yearID != 2020) |>
  select(teamID, yearID, lgID, G, W, L, R, RA)
my_teams |>
  slice_tail(n = 6)

my_teams <- my_teams |>
  mutate(RD = R - RA, Wpct = W / (W + L))

run_diff <- ggplot(my_teams, aes(x = RD, y = Wpct)) + 
  geom_point() + 
  scale_x_continuous("Run differential") + 
  scale_y_continuous("Winning percentage")
run_diff

#4.3
linfit <- lm(Wpct ~ RD, data = my_teams)
linfit

run_diff + 
  geom_smooth(method = "lm", se = FALSE, color = "#ffb3c6")


library(broom)
my_teams_aug <- augment(linfit, data = my_teams)

base_plot <- ggplot(my_teams_aug, aes(x = RD, y = .resid)) +
  geom_point(alpha = 0.3) + 
  geom_hline(yintercept = 0, linetype = 3) + 
  xlab("Run differential") + ylab("Residual")

highlight_teams <- my_teams_aug |>
  arrange(desc(abs(.resid))) |>
  slice_head(n = 6)

library(ggrepel)
base_plot +
  geom_point(data = highlight_teams, color = "#ffb3c6") + 
  geom_text_repel(
    data = highlight_teams, color = "#ffb3c6",
    aes(label = paste(teamID, yearID))
  )

resid_summary <- my_teams_aug |>
  summarize(
    N = n(), 
    avg = mean(.resid), 
    RMSE = sqrt(mean(.resid^2))
  )
resid_summary

rmse <- resid_summary |>
  pull(RMSE)

my_teams_aug |>
  summarize(
    N = n(), 
    within_one = sum(abs(.resid) < rmse),
    within_two = sum(abs(.resid) < 2 * rmse)
  ) |>
  mutate(
    within_one_pct = within_one / N, 
    within_two_pct = within_two / N
  )

#4.4
my_teams <- my_teams |>
  mutate(Wpct_pyt = R ^ 2 / (R ^ 2 + RA ^ 2))

my_teams <- my_teams |>
  mutate(residuals_pyt = Wpct - Wpct_pyt) 
my_teams |>
  summarize(rmse = sqrt(mean(residuals_pyt^2)))

#4.4.1
my_teams <- my_teams |>
  mutate(
    logWratio = log(W / L), 
    logRratio = log(R / RA)
  )

pytFit <- lm(logWratio ~ 0 + logRratio, data = my_teams)
pytFit

#4.4.2
library(abdwr3edata)
gl2011 <- retro_gl_2011

BOS2011 <- gl2011 |>
  filter(HomeTeam == "BOS" | VisitingTeam == "BOS") |>
  select(
    VisitingTeam, HomeTeam, 
    VisitorRunsScored, HomeRunsScore
  )
slice_head(BOS2011, n = 6)

BOS2011 <- BOS2011 |>
  mutate(
    ScoreDiff = ifelse(
      HomeTeam == "BOS", 
      HomeRunsScore - VisitorRunsScored, 
      VisitorRunsScored - HomeRunsScore
    ), 
    W = ScoreDiff > 0
  )

library(skimr)
BOS2011 |>
  group_by(W) |>
  skim(ScoreDiff) |>
  print(include_summary = FALSE)

results <- gl2011 |>
  select(
    VisitingTeam, HomeTeam, 
    VisitorRunsScored, HomeRunsScore
  ) |>
  mutate(
    winner = ifelse(
      HomeRunsScore > VisitorRunsScored, 
      HomeTeam, VisitingTeam
    ),
    diff = abs(VisitorRunsScored - HomeRunsScore)
  )

one_run_wins <- results |>
  filter(diff == 1) |>
  group_by(winner) |>
  summarize(one_run_w = n())

teams2011 <- my_teams |>
  filter(yearID == 2011) |>
  mutate(
    teamID = if_else(teamID == "LAA", "ANA", as.character(teamID)
    )
  ) |>
  inner_join(one_run_wins, by = c("teamID" = "winner"))

ggplot(data = teams2011, aes(x = one_run_w, y = residuals_pyt)) +
  geom_point() +
  geom_text_repel(aes(label = teamID)) + 
  xlab("One run wins") + ylab("Pythagorean residuals")

top_closers <- Pitching |>
  filter(GF > 50 & ERA < 2.5) |>
  select(playerID, yearID, teamID)

my_teams |>
  inner_join(top_closers) |>
  pull(residuals_pyt) |>
  summary()


```
期中報告可以做的內容
- 畢達哥拉斯
- 名人堂

2025.10.20 作業
要用老師朋友的書第一章的題目

